build:
  builder:
    image: clamp/builder:0.2.0
    pull: true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - docker build -t clamp/builder:$$BUILD_NUMBER images
  volume-container:
    image: clamp/builder:$$BUILD_NUMBER
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - docker build -t clamp/lib-volume:$$BUILD_NUMBER images/lib/volume
  base-container:
    image: clamp/builder:$$BUILD_NUMBER
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - export BUILD_NUMBER=$$BUILD_NUMBER
      - BUILD_TYPE=lib
      - BUILD_NAME=base
      - BUILD=images/$BUILD_TYPE/$BUILD_NAME
      - IMAGE=clamp/$BUILD_TYPE-$BUILD_NAME
      - $(cat images/lib/base/Dockerfile | grep ENV | cut -d \  -f 2 | cut -d = -f 1 | xargs -L1 ./export.sh)
      - BUILD_NUMBER=$$BUILD_NUMBER eval "echo \"$(<$BUILD/Dockerfile)\"" >$BUILD/Dockerfile
      - docker build -t $IMAGE:$$BUILD_NUMBER $BUILD
  mysql-container:
    image: clamp/builder:$$BUILD_NUMBER
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - docker build -t clamp/lib-mysql:$$BUILD_NUMBER images/lib/mysql
  php-container:
    image: clamp/builder:$$BUILD_NUMBER
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - docker build -t clamp/lib-php-7:$$BUILD_NUMBER images/lib/php-7
  consul-container:
    image: clamp/builder:$$BUILD_NUMBER
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - docker build -t clamp/lib-consul-server:$$BUILD_NUMBER images/lib/consul-server
  mysql-run-container:
    image: clamp/builder:$$BUILD_NUMBER
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - docker build -t clamp/run-mysql:$$BUILD_NUMBER images/run/mysql
  plugin-run-container:
    image: clamp/builder:$$BUILD_NUMBER
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - docker build -t clamp/run-plugin:$$BUILD_NUMBER images/run/plugin
  wordpress-run-container:
    image: clamp/builder:$$BUILD_NUMBER
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - docker build -t clamp/run-wordpress:$$BUILD_NUMBER images/run/wordpress
  memcached-run-container:
    image: clamp/builder:$$BUILD_NUMBER
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - docker build -t clamp/run-memcached:$$BUILD_NUMBER images/run/memcached
  nginx-run-container:
    image: clamp/builder:$$BUILD_NUMBER
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - docker build -t clamp/run-nginx:$$BUILD_NUMBER images/run/nginx
  php-fpm-run-container:
    image: clamp/builder:$$BUILD_NUMBER
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - docker build -t clamp/run-php-fpm:$$BUILD_NUMBER images/run/php-fpm
  haproxy-run-container:
    image: clamp/builder:$$BUILD_NUMBER
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - docker build -t clamp/run-haproxy:$$BUILD_NUMBER images/run/haproxy
  plugin-builder-container:
    image: clamp/builder:$$BUILD_NUMBER
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - docker build -t clamp/srv-composer:$$BUILD_NUMBER images/srv/composer
  tag-release:
    image: clamp/builder:$$BUILD_NUMBER
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - docker tag clamp/lib-base:$$BUILD_NUMBER clamp/lib-base:$$TAG
      - docker tag clamp/lib-consul-server:$$BUILD_NUMBER clamp/lib-consul-server:$$TAG
      - docker tag clamp/lib-mysql:$$BUILD_NUMBER clamp/lib-mysql:$$TAG
      - docker tag clamp/lib-php-7:$$BUILD_NUMBER clamp/lib-php-7:$$TAG
      - docker tag clamp/lib-volume:$$BUILD_NUMBER clamp/lib-volume:$$TAG
      - docker tag clamp/run-haproxy:$$BUILD_NUMBER clamp/run-haproxy:$$TAG
      - docker tag clamp/run-memcached:$$BUILD_NUMBER clamp/run-memcached:$$TAG
      - docker tag clamp/run-mysql:$$BUILD_NUMBER clamp/run-mysql:$$TAG
      - docker tag clamp/run-nginx:$$BUILD_NUMBER clamp/run-nginx:$$TAG
      - docker tag clamp/run-php-fpm:$$BUILD_NUMBER clamp/run-php-fpm:$$TAG
      - docker tag clamp/run-plugin:$$BUILD_NUMBER clamp/run-plugin:$$TAG
      - docker tag clamp/run-wordpress:$$BUILD_NUMBER clamp/run-wordpress:$$TAG
      - docker tag clamp/srv-composer:$$BUILD_NUMBER clamp/run-composer:$$TAG
      - docker tag clamp/lib-base:$$BUILD_NUMBER clamp/lib-base:$$TAG
      - docker tag clamp/lib-consul-server:$$BUILD_NUMBER clamp/lib-consul-server:latest
      - docker tag clamp/lib-mysql:$$BUILD_NUMBER clamp/lib-mysql:latest
      - docker tag clamp/lib-php-7:$$BUILD_NUMBER clamp/lib-php-7:latest
      - docker tag clamp/lib-volume:$$BUILD_NUMBER clamp/lib-volume:latest
      - docker tag clamp/run-haproxy:$$BUILD_NUMBER clamp/run-haproxy:latest
      - docker tag clamp/run-memcached:$$BUILD_NUMBER clamp/run-memcached:latest
      - docker tag clamp/run-mysql:$$BUILD_NUMBER clamp/run-mysql:latest
      - docker tag clamp/run-nginx:$$BUILD_NUMBER clamp/run-nginx:latest
      - docker tag clamp/run-php-fpm:$$BUILD_NUMBER clamp/run-php-fpm:latest
      - docker tag clamp/run-plugin:$$BUILD_NUMBER clamp/run-plugin:latest
      - docker tag clamp/run-wordpress:$$BUILD_NUMBER clamp/run-wordpress:latest
      - docker tag clamp/srv-composer:$$BUILD_NUMBER clamp/run-composer:latest
    when:
      event: tag
  tag-pr:
    image: clamp/builder:$$BUILD_NUMBER
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - docker tag clamp/lib-base:$$BUILD_NUMBER clamp/lib-base:$${BRANCH///-}
      - docker tag clamp/lib-consul-server:$$BUILD_NUMBER clamp/lib-consul-server:$${BRANCH///-}
      - docker tag clamp/lib-mysql:$$BUILD_NUMBER clamp/lib-mysql:$${BRANCH///-}
      - docker tag clamp/lib-php-7:$$BUILD_NUMBER clamp/lib-php-7:$${BRANCH///-}
      - docker tag clamp/lib-volume:$$BUILD_NUMBER clamp/lib-volume:$${BRANCH///-}
      - docker tag clamp/run-haproxy:$$BUILD_NUMBER clamp/run-haproxy:$${BRANCH///-}
      - docker tag clamp/run-memcached:$$BUILD_NUMBER clamp/run-memcached:$${BRANCH///-}
      - docker tag clamp/run-mysql:$$BUILD_NUMBER clamp/run-mysql:$${BRANCH///-}
      - docker tag clamp/run-nginx:$$BUILD_NUMBER clamp/run-nginx:$${BRANCH///-}
      - docker tag clamp/run-php-fpm:$$BUILD_NUMBER clamp/run-php-fpm:$${BRANCH///-}
      - docker tag clamp/run-plugin:$$BUILD_NUMBER clamp/run-plugin:$${BRANCH///-}
      - docker tag clamp/run-wordpress:$$BUILD_NUMBER clamp/run-wordpress:$${BRANCH///-}
      - docker tag clamp/srv-composer:$$BUILD_NUMBER clamp/run-composer:$${BRANCH///-}
      - docker tag clamp/lib-base:$$BUILD_NUMBER clamp/lib-base:$${BRANCH///-}
    when:
      event: pull_request
publish:
  docker:
    username: $$DUSER
    password: $$DPASS
    email: $$DEMAIL
    repo: clamp/builder
    tag: $$BUILD_NUMBER
    when:
      event: [pull_request]
clone:
  path: /build